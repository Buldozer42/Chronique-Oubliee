{% extends 'base.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/framework/js/prototype.min.js') }}"></script>
    <script src="{{ asset('bundles/framework/js/collection.min.js') }}"></script>
{% endblock %}
{% block body %}
{% include 'navbar.html.twig' %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 align-center">
            <h1>Créer un personnage</h1>
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="flash-{{ label }}">
                        {% if label == 'success' %}
                            <div class="alert alert-success" role="alert">
                        {% elseif label == 'error' %}
                            <div class="alert alert-danger" role="alert">
                        {% elseif label == 'info' %}
                            <div class="alert alert-primary" role="alert">
                        {% else %}
                            <div class="alert alert-light" role="alert">
                        {% endif %}
                        {{ message }}
                        </div>
                    </div>
                {% endfor %}
            {% endfor %}

            {{ form_start(form) }}
            <h3> Information de base </h3>
            <div class="ms-2 mb-4">
                <div class="form-group">
                    {{ form_label(form.name) }}
                    {{ form_widget(form.name) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.class) }}
                    {{ form_widget(form.class) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.level) }}
                    {{ form_widget(form.level) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.race) }}
                    {{ form_widget(form.race) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.sexe) }}
                    {{ form_widget(form.sexe) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.age) }}
                    {{ form_widget(form.age) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.height) }}
                    {{ form_widget(form.height) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.weight) }}
                    {{ form_widget(form.weight) }}
                </div>
            </div>

            <h3> Caractéristique </h3>
            <div class="ms-2 mb-4">
                <div class="form-group">
                    {{ form_label(form.fo) }}
                    {{ form_widget(form.fo) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.dex) }}
                    {{ form_widget(form.dex) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.con) }}
                    {{ form_widget(form.con) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.int) }}
                    {{ form_widget(form.int) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.sag) }}
                    {{ form_widget(form.sag) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.cha) }}
                    {{ form_widget(form.cha) }}
                </div>
                <div class="my-3">
                    <div class="d-flex my-2">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form_label(form.advantage_fo) }}
                                {{ form_widget(form.advantage_fo) }}
                            </div>
                            <div class="form-group">
                                {{ form_label(form.advantage_dex) }}
                                {{ form_widget(form.advantage_dex) }}
                            </div>
                            <div class="form-group">
                                {{ form_label(form.advantage_con) }}
                                {{ form_widget(form.advantage_con) }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form_label(form.advantage_int) }}
                                {{ form_widget(form.advantage_int) }}
                            </div>
                            <div class="form-group">
                                {{ form_label(form.advantage_sag) }}
                                {{ form_widget(form.advantage_sag) }}
                            </div>
                            <div class="form-group">
                                {{ form_label(form.advantage_cha) }}
                                {{ form_widget(form.advantage_cha) }}
                            </div>
                        </div> 
                    </div>
                    <div class="d-flex  my-2">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form_label(form.magic_int) }}
                                {{ form_widget(form.magic_int) }}
                            </div>
                            <div class="form-group">
                                {{ form_label(form.magic_sag) }}
                                {{ form_widget(form.magic_sag) }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form_label(form.magic_cha) }}
                                {{ form_widget(form.magic_cha) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h3> Vitalité </h3>
            <div class="ms-2 mb-4">
                <div class="form-group">
                    {{ form_label(form.dice_life) }}
                    {{ form_widget(form.dice_life) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.max_hp) }}
                    {{ form_widget(form.max_hp) }}
                </div>
            </div>

            <h3> Défence </h3>
            <div class="ms-2 mb-4">
                <div class="form-group">
                    {{ form_label(form.bonus_init) }}
                    {{ form_widget(form.bonus_init) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.def) }}
                    {{ form_widget(form.def) }}
                </div>
            </div>

            <h3> Cappacité </h3>
            <div class="ms-2 mb-4">
                <div class="form-group">
                    {{ form_label(form.racial_skil) }}
                    {{ form_widget(form.racial_skil) }}
                </div>
                <div class="form-group">
                    <label class="from-label required" for="languages">Langues</label>
                    <ul class="languages list-group"
                        data-index="{{ form.languages|length > 0 ? form.languages|last.vars.name + 1 : 0 }}"
                        data-prototype="{{ form_widget(form.languages.vars.prototype)|e('html_attr') }}"
                    >
                        {% for language in form.languages %}
                            <li class="list-group-item">{{ form_widget(language.name) }}</li>
                        {% endfor %}
                    </ul>
                    <button type="button" class=" btn btn-primary add_item_link my-2" data-collection-holder-class="languages">Ajouter une langue</button>
                </div>
            </div>

            <h3> Équipement </h3>
            <div class="ms-2 mb-4">
                {% for i in range(1, 3) %}
                    <div class="mt-3">
                        <input class="form-check-input weapons-checkbox" type="checkbox" data-num="{{ i }}">
                        <label class="form-check-label" for="">
                            Pas d'arme {{ i }}
                        </label>
                    </div>
                    <div class="form-group">
                        {{ form_label(attribute(form, 'weapon' ~ i ~ '_name')) }}
                        {{ form_widget(attribute(form, 'weapon' ~ i ~ '_name')) }}
                    </div>
                    <div class="form-group">
                        {{ form_label(attribute(form, 'weapon' ~ i ~ '_att')) }}
                        {{ form_widget(attribute(form, 'weapon' ~ i ~ '_att')) }}
                    </div>
                    <div class="form-group">
                        {{ form_label(attribute(form, 'weapon' ~ i ~ '_dm')) }}
                        {{ form_widget(attribute(form, 'weapon' ~ i ~ '_dm')) }}
                    </div>
                    <div class="form-group">
                        {{ form_label(attribute(form, 'weapon' ~ i ~ '_special')) }}
                        {{ form_widget(attribute(form, 'weapon' ~ i ~ '_special')) }}
                    </div>
                {% endfor %}
            
                <div class="form-group">
                    <label class="from-label required" for="inventory">Inventaire</label>
                    <ul class="inventory list-group"
                        data-index="{{ form.inventory|length > 0 ? form.inventory|last.vars.name + 1 : 0 }}"
                        data-prototype="{{ form_widget(form.inventory.vars.prototype)|e('html_attr') }}"
                    >
                        {% for inventoryItem in form.inventory %}
                            <li class="list-group-item">{{ form_widget(inventoryItem.name) }}</li>
                        {% endfor %}
                    </ul>
                    <button type="button" class=" btn btn-primary add_item_link my-2" data-collection-holder-class="inventory">Ajouter un objet</button>
                    <button type="button" class=" btn btn-primary add_base_inventory_link my-2" data-collection-holder-class="inventory">Inventaire de base</button>
                </div>
                <div class="form-group">
                    {{ form_label(form.clutter) }}
                    {{ form_widget(form.clutter) }}
                </div>
            </div>

            <h3> Lore </h3>
            <div class="ms-2 mb-4">
                <div class="form-group">
                    {{ form_label(form.description) }}
                    {{ form_widget(form.description) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.story) }}
                    {{ form_widget(form.story) }}
                </div>
            </div>

            <h3> Bourse </h3>
            <div class="ms-2 mb-4">
                <div class="form-group">
                    {{ form_label(form.pa) }}
                    {{ form_widget(form.pa) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.po) }}
                    {{ form_widget(form.po) }}
                </div>
            </div>

            <h3> Voie </h3>
            <div class="ms-2 mb-4">
                <p> La voie 6 corespond à la voie de prestige </p>
                {% for i in range(1, 6) %}
                    <div class="form-check mt-4">
                        <input class="{{'form-check-input path' ~ i ~ 'checkboxdisabled'}}" type="checkbox" value="" 
                            id={{ 'path' ~ i ~'checkbox' }}>
                        <label class="form-check-label" for="">
                            Voie non aquise
                        </label>
                    </div>
                    <div class="form-group">
                        {{ form_label(attribute(form, 'path' ~ i ~ '_name')) }}
                        {{ form_widget(attribute(form, 'path' ~ i ~ '_name')) }}
                    </div>
                    {% for y in range(1, 5) %}
                        <div class="form-check mt-2">
                            <input class="{{'form-check-input path' ~ i ~ 'checkboxdisabled'}}" type="checkbox" value="" 
                                id={{ 'path' ~ i ~'comp' ~ y ~ 'checkbox' }}>
                            <label class="form-check-label" for="">
                                Cappacité non aquise
                            </label>
                        </div>
                        <div class="form-group">
                            {{ form_label(attribute(form, 'path' ~ i ~ '_comp' ~ y ~ '_name')) }}
                            {{ form_widget(attribute(form, 'path' ~ i ~ '_comp' ~ y ~ '_name')) }}
                        </div>
                        <div class="form-group">
                            {{ form_label(attribute(form, 'path' ~ i ~ '_comp' ~ y ~ '_desc')) }}
                            {{ form_widget(attribute(form, 'path' ~ i ~ '_comp' ~ y ~ '_desc')) }}
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>

            <h3> Règles optionelles </h3>
            <div class="ms-2 mb-4">
                <div class="form-group">
                    {{ form_label(form.max_pc) }}
                    {{ form_widget(form.max_pc) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.max_pr) }}
                    {{ form_widget(form.max_pr) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.max_pm) }}
                    {{ form_widget(form.max_pm) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.em) }}
                    {{ form_widget(form.em) }}
                </div>
            </div>
            <h3> Points actuels </h3>
            <div class="ms-2">
                <div class="form-group">
                    {{ form_label(form.hp) }}
                    {{ form_widget(form.hp) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.pc) }}
                    {{ form_widget(form.pc) }}
                </div>
                 <div class="form-group">
                    {{ form_label(form.pr) }}
                    {{ form_widget(form.pr) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.pm) }}
                    {{ form_widget(form.pm) }}
                </div>
            </div>

            <div class="form-group">
                {{ form_widget(form.att_con) }}
            </div>
            <div class="form-group">
                {{ form_widget(form.att_mag) }}
            </div>
            <div class="form-group">
                {{ form_widget(form.att_dis) }}
            </div>
            <div class="form-group">
                {{ form_widget(form.init) }}
            </div>
            <div class="form-group">
                {{ form_widget(form.detrimental_states) }}
            </div>

            {{ form_rest(form) }}
            <input type="submit" class="btn btn-primary my-2"/>
            {{ form_end(form) }}
        </div>
    </div>
</div>
<script>
    $(document).ready(function(){
        $("#player_form_max_hp").on("input", function() {
            let maxHp = $(this).val();
            $("#player_form_hp").attr("max", maxHp);
            $("#player_form_hp").val(maxHp);
        });
        $("#player_form_max_pc").on("input", function() {
            let maxPc = $(this).val();
            $("#player_form_pc").attr("max", maxPc);
            $("#player_form_pc").val(maxPc);
        });
        $("#player_form_max_pr").on("input", function() {
            let maxPr = $(this).val();
            $("#player_form_pr").attr("max", maxPr);
            $("#player_form_pr").val(maxPr);
        });
        $("#player_form_max_pm").on("input", function() {
            let maxPm = $(this).val();
            $("#player_form_pm").attr("max", maxPm);
            $("#player_form_pm").val(maxPm);
        });

        $(".weapons-checkbox").click(function(){
            let num = $(this).data("num");
            if($(this).is(":checked")){
                $("#player_form_weapon" + num + "_name").attr("disabled", true);
                $("#player_form_weapon" + num + "_name").val('Aucun');

                $("#player_form_weapon" + num + "_att").attr("disabled", true);
                $("#player_form_weapon" + num + "_att").val(0);
                
                $("#player_form_weapon" + num + "_dm").attr("disabled", true);
                $("#player_form_weapon" + num + "_dm").val('0');

                $("#player_form_weapon" + num + "_special").attr("disabled", true);
                $("#player_form_weapon" + num + "_special").val('Aucun');
            }else{
                $("#player_form_weapon" + num + "_name").removeAttr("disabled");
                $("#player_form_weapon" + num + "_name").val('');

                $("#player_form_weapon" + num + "_att").removeAttr("disabled");
                $("#player_form_weapon" + num + "_att").val('');

                $("#player_form_weapon" + num + "_dm").removeAttr("disabled");
                $("#player_form_weapon" + num + "_dm").val('');

                $("#player_form_weapon" + num + "_special").removeAttr("disabled");
                $("#player_form_weapon" + num + "_special").val('');
            }
        });
    });

    const addFormDeleteLink = (item) => {
        const removeFormButton = document.createElement('button');
        removeFormButton.innerText = 'X';
        removeFormButton.classList.add('btn', 'btn-danger', 'btn-sm', 'mb-1');

        item.append(removeFormButton);

        removeFormButton.addEventListener('click', (e) => {
            e.preventDefault();
            item.remove();
        });
    };

    const addFormToCollection = (e) => {
        const collectionHolder = document.querySelector('.' + e.currentTarget.dataset.collectionHolderClass);
        const div = document.createElement('div');
        div.classList.add('d-flex', 'align-items-center');
        const item = document.createElement('li');
        item.innerHTML = collectionHolder.dataset.prototype.replace(/__name__/g, collectionHolder.dataset.index);
        div.append(item);
        collectionHolder.appendChild(div);
        collectionHolder.dataset.index++;
        addFormDeleteLink(div);
    };

    const addBaseInventory = (e) => {
        const inventory = [
            "Sac d'aventurier",
            "Couverture",
            "Torche",
            "Briquet à silex",
            "Outre",
            "Gamelle",
        ];

        const collectionHolder = document.querySelector('.' + e.currentTarget.dataset.collectionHolderClass);

        inventory.forEach(function(baseItem) {
            const div = document.createElement('div');
            div.classList.add('d-flex', 'align-items-center');
            const item = document.createElement('li');
            item.innerHTML = collectionHolder.dataset.prototype.replace(/__name__/g, collectionHolder.dataset.index);
            div.append(item);
            collectionHolder.appendChild(div);
            collectionHolder.dataset.index++;
            addFormDeleteLink(div);

            item.querySelector('input').value = baseItem;
        });
    };

    document
    .querySelectorAll('ul.languages li')
    .forEach((language) => {
        addFormDeleteLink(language)
    });
    document
    .querySelectorAll('ul.inventory li')
    .forEach((inventoryItem) => {
        addFormDeleteLink(inventoryItem)
    });
    document
    .querySelectorAll('.add_item_link')
    .forEach(btn => {
        btn.addEventListener("click", addFormToCollection)
    });
    document
    .querySelector('.add_base_inventory_link')
    .addEventListener("click", addBaseInventory);

    for (let i = 1; i <=6 ; i++) {
        const pathcheckbox = document.querySelector('#path' + i + 'checkbox');
        pathcheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            if (isChecked) {
                if (i != 6) {
                    for (let x = i; x <= 5; x++){
                        const pathdisabled = document.querySelectorAll('.path' + x + 'disabled');
                        pathdisabled.forEach(function(value, index) {
                            value.value = 'Pas acquise';
                            value.disabled = true;
                        });

                        const pathcheckboxdisabled = document.querySelectorAll('.path' + x + 'checkboxdisabled');
                        pathcheckboxdisabled.forEach(function(value, index) {
                            value.checked = true;
                        });
                    }
                } else {
                    const pathdisabled = document.querySelectorAll('.path6disabled');
                    pathdisabled.forEach(function(value, index) {
                        value.value = 'Pas acquise';
                        value.disabled = true;
                    });

                    const pathcheckboxdisabled = document.querySelectorAll('.path6checkboxdisabled');
                    pathcheckboxdisabled.forEach(function(value, index) {
                        value.checked = true;
                    });
                }
            } else {
                if (i != 6){
                    for (let x = i; x >= 1; x--){
                        const pathdisabled = document.querySelectorAll('.path' + x + 'disabled');
                        pathdisabled.forEach(function(value, index) {
                            value.value = '';
                            value.disabled = false;
                        });

                        const pathcheckboxdisabled = document.querySelectorAll('.path' + x + 'checkboxdisabled');
                        pathcheckboxdisabled.forEach(function(value, index) {
                            value.checked = false;
                        });
                    }
                } else {
                    const pathdisabled = document.querySelectorAll('.path6disabled');
                    pathdisabled.forEach(function(value, index) {
                        value.value = '';
                        value.disabled = false;
                    });

                    const pathcheckboxdisabled = document.querySelectorAll('.path6checkboxdisabled');
                    pathcheckboxdisabled.forEach(function(value, index) {
                        value.checked = false;
                    });
                }
            }
        });
        for (let y = 1; y <= 5; y++){
            const pathcompcheckbox = document.querySelector('#path' + i + 'comp' + y + 'checkbox');
            pathcompcheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                if (isChecked) {
                    for ( let x = y; x <= 5; x++ ){
                        const pathcompname = document.querySelector('.path' + i + '_comp' + x +'_name');
                        const pathcompdesc = document.querySelector('.path' + i + '_comp' + x +'_desc');
                        const pathcompcheckbox = document.querySelector('#path' + i + 'comp' + x + 'checkbox');

                        pathcompname.value = 'Pas acquise';
                        pathcompname.disabled = true;

                        pathcompdesc.value = 'Pas acquise';
                        pathcompdesc.disabled = true;

                        pathcompcheckbox.checked = true;

                    }
                } else {
                    const pathname = document.querySelector('.path' + i + '_name');
                    pathname.value = '';
                    pathname.disabled = false;

                    const pathcheckbox = document.querySelector('#path' + i + 'checkbox');
                    pathcheckbox.checked = false;
                    
                    for ( let x = y; x >= 1; x-- ){
                        const pathcompname = document.querySelector('.path' + i + '_comp' + x +'_name');
                        const pathcompdesc = document.querySelector('.path' + i + '_comp' + x +'_desc');
                        const pathcompcheckbox = document.querySelector('#path' + i + 'comp' + x + 'checkbox');

                        pathcompname.value = '';
                        pathcompname.disabled = false;

                        pathcompdesc.value = '';
                        pathcompdesc.disabled = false;

                        pathcompcheckbox.checked = false;

                    }
                }
            });
        }
    }

</script>
{% endblock %}